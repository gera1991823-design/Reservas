<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reservas de Importaciones</title>

  <!-- XLSX (SheetJS) para exportar a Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      /* John Deere accents */
      --jd-green:#367C2B;
      --jd-yellow:#FFDE00;

      /* Darker / more black */
      --bg:#050705;
      --panel:#0a0f0a;
      --panel2:#0c140c;
      --row:#070b07;
      --row-alt:#090f09;

      --text:#e9f3e9;
      --muted:#a7c1a7;

      --line:rgba(255,222,0,.16);
      --radius:14px;
      --shadow: 0 18px 45px rgba(0,0,0,.60);
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(900px 600px at 15% 0%, rgba(54,124,43,.20), transparent 60%),
        radial-gradient(700px 500px at 85% 10%, rgba(255,222,0,.10), transparent 55%),
        linear-gradient(180deg, #040604 0%, #050905 100%);
      color:var(--text);
    }

    .wrap{ width:100%; margin:0; padding:18px; }

    header{
      display:flex; flex-wrap:wrap; gap:14px;
      justify-content:space-between; align-items:flex-end;
      margin-bottom:14px;
    }

    .title{ display:flex; flex-direction:column; gap:6px; }
    .title h1{ margin:0; font-size:22px; letter-spacing:.3px; }
    .title p{ margin:0; font-size:13px; color:var(--muted); }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:flex-end;
    }

    .control{
      background:linear-gradient(180deg, rgba(10,15,10,.95), rgba(8,12,8,.95));
      border:1px solid rgba(255,222,0,.18);
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      min-height:42px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(54,124,43,.12);
    }
    .control::placeholder{ color:rgba(233,243,233,.40); }

    .btn{
      background:linear-gradient(180deg, rgba(10,15,10,.92), rgba(8,12,8,.92));
      border:1px solid rgba(255,222,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:10px 14px;
      min-height:42px;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      outline:none;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }
    .btn:hover{ border-color:rgba(255,222,0,.35); transform:translateY(-1px); }
    .btn.primary{
      background:linear-gradient(135deg, rgba(54,124,43,.85), rgba(10,15,10,.92));
      border-color:rgba(255,222,0,.45);
      box-shadow: 0 10px 22px rgba(54,124,43,.18);
    }
    .btn.danger{
      background:linear-gradient(135deg, rgba(120,20,20,.40), rgba(10,15,10,.92));
      border-color:rgba(255,80,80,.45);
    }

    .card{
      background:linear-gradient(180deg, rgba(12,20,12,.86), rgba(8,12,8,.88));
      border:1px solid rgba(255,222,0,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .meta{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap;
      padding:12px 14px;
      background:linear-gradient(90deg, rgba(54,124,43,.45), rgba(0,0,0,.35));
      border-bottom:1px solid rgba(255,222,0,.14);
    }

    .pill{
      font-size:12px;
      border:1px solid rgba(255,222,0,.14);
      border-radius:999px;
      padding:6px 12px;
      color:var(--muted);
      background:rgba(0,0,0,.30);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .dot{
      width:8px; height:8px; border-radius:999px;
      background:var(--jd-yellow);
      box-shadow:0 0 0 6px rgba(255,222,0,.10);
    }

    .table-wrap{ width:100%; overflow:auto; max-height:calc(100vh - 230px); }

    table{
      width:100%;
      min-width:1500px;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
    }

    thead th{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg, rgba(54,124,43,.92), rgba(20,55,18,.92));
      color:#fff;
      padding:11px 10px;
      border-bottom:2px solid var(--jd-yellow);
      white-space:nowrap;
      font-weight:800;
      letter-spacing:.2px;
      text-align:center; /* centrado */
    }

    tbody td{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,222,0,.06);
      background:var(--row);
      white-space:nowrap;
      vertical-align:middle;
      text-align:center; /* centrado */
    }

    tbody tr:nth-child(even) td{ background:var(--row-alt); }
    tbody tr:hover td{ background:rgba(54,124,43,.22); }

    /* foco edici√≥n sin amarillo fuerte */
    tbody td[contenteditable="true"]:focus{
      outline:2px solid rgba(255,222,0,.55);
      border-radius:8px;
      background: rgba(0,0,0,.55);
      color: var(--text);
    }

    .col-small{ width: 120px; }
    .col-xs{ width: 90px; }
    .col-mid{ width: 160px; }
    .col-wide{ width: 240px; }

    .jd-select{
      width:100%;
      min-width:150px;
      background:rgba(0,0,0,.45);
      color:var(--text);
      border:1px solid rgba(255,222,0,.18);
      border-radius:10px;
      padding:6px 10px;
      outline:none;
      text-align:center;
    }
    .jd-select:focus{
      border-color:rgba(255,222,0,.55);
      box-shadow:0 0 0 3px rgba(255,222,0,.10);
    }

    .row-actions{
      display:flex; gap:8px;
      align-items:center; justify-content:center;
    }

    .icon-btn{
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid rgba(255,222,0,.14);
      background:rgba(0,0,0,.45);
      color:var(--text);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:.15s ease;
    }
    .icon-btn:hover{ border-color:rgba(255,222,0,.45); transform:translateY(-1px); }
    .icon-btn.danger{ border-color:rgba(255,80,80,.45); background:rgba(120,20,20,.35); }

    .footer{
      padding:12px 14px;
      border-top:1px solid rgba(255,222,0,.12);
      background:rgba(0,0,0,.45);
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .footer code{ font-family:var(--mono); color:var(--text); }

    @media (max-width: 760px){
      .toolbar{ justify-content:stretch; }
      .control, .btn{ flex: 1; }
      table{ min-width: 1400px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Reservas de Importaciones</h1>
        <p>Tabla editable ¬∑ buscador + filtro ¬∑ exportaci√≥n Excel (XLSX) ¬∑ sincronizada con Firebase</p>
      </div>

      <div class="toolbar">
        <input id="search" class="control" style="min-width:260px" placeholder="Buscar (caja, material, OC, descripci√≥n...)" />
        <select id="filterCumplido" class="control">
          <option value="all">Cumplido: Todos</option>
          <option value="si">Cumplido: S√≠</option>
          <option value="no">Cumplido: No</option>
          <option value="sin realizar">Cumplido: Sin realizar</option>
        </select>

        <button class="btn primary" id="addRow">Ôºã Agregar fila</button>
        <button class="btn" id="exportXlsx">‚¨á Exportar XLSX</button>
        <button class="btn danger" id="clearAll">üóë Vaciar</button>
      </div>
    </header>

    <div class="card">
      <div class="meta">
        <div class="pill"><span class="dot"></span> Vista principal</div>
        <div class="pill">Filas: <strong id="rowCount" style="color:var(--text)">0</strong></div>
      </div>

      <div class="table-wrap">
        <table id="grid">
          <thead>
            <tr>
              <th class="col-small">Caja</th>
              <th class="col-small">Material</th>
              <th class="col-xs">Cantidad pack</th>
              <th class="col-xs">Cantid</th>
              <th class="col-wide">Descripci√≥n</th>
              <th class="col-wide">Comentario</th>
              <th class="col-mid">O/C</th>
              <th class="col-xs">Carpeta</th>
              <th class="col-mid">Pedido Trasla</th>
              <th class="col-xs">Sucurs</th>
              <th class="col-mid">Fecha</th>
              <th class="col-mid">Hora de carga</th>
              <th class="col-small">Cumplido</th>
              <th class="col-xs">Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div>Tip: click en una celda para editar. Enter confirma. Cambios se sincronizan en Firebase.</div>
        <div>Backend: <code>Firebase Firestore</code></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs (compat, sin imports) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration (TU PROYECTO)
    const firebaseConfig = {
      apiKey: "AIzaSyArWJrKqGDuyGj6LtbmaY3MH6YZ-DE_46A",
      authDomain: "reservas-isa.firebaseapp.com",
      projectId: "reservas-isa",
      storageBucket: "reservas-isa.appspot.com",
      messagingSenderId: "970684177150",
      appId: "1:970684177150:web:3292e4657e21a6c43ce3af"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    /* =========================
       APP (Firestore sincronizado)
    ========================== */

    const columns = [
      "caja","material","cantidadPack","cantid","descripcion","comentario",
      "oc","carpeta","pedidoTrasla","sucurs","fecha","horaCarga","cumplido"
    ];

    const tbody = document.getElementById("tbody");
    const search = document.getElementById("search");
    const filterCumplido = document.getElementById("filterCumplido");
    const rowCount = document.getElementById("rowCount");

    function pad2(n){ return String(n).padStart(2,"0"); }
    function nowDateStr(){
      const d = new Date();
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    }
    function nowTimeStr(){
      const d = new Date();
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    // Datos en memoria (vienen de Firestore)
    let data = [];

    function matchesFilters(row){
      const q = search.value.trim().toLowerCase();
      const f = filterCumplido.value;

      const haystack = columns
        .map(k => (row[k] ?? "").toString().toLowerCase())
        .join(" | ");

      const okSearch = !q || haystack.includes(q);

      let okCumplido = true;
      if(f !== "all"){
        const v = (row.cumplido ?? "").toString().trim().toLowerCase();
        const isYes = (v === "si" || v === "s√≠");
        const isNo = (v === "no");
        const isPending = (v === "sin realizar" || v === "");
        if(f === "si") okCumplido = isYes;
        if(f === "no") okCumplido = isNo;
        if(f === "sin realizar") okCumplido = isPending;
      }

      return okSearch && okCumplido;
    }

    function render(){
      tbody.innerHTML = "";

      const visible = data.filter(matchesFilters);
      rowCount.textContent = visible.length;

      for(const row of visible){
        const tr = document.createElement("tr");

        for(const key of columns){
          const td = document.createElement("td");
          td.dataset.key = key;
          td.dataset.id = row.id;

          if(key === "cumplido"){
            const current = (row[key] ?? "SIN REALIZAR").toString().trim().toUpperCase();
            const normalized = (current === "" ? "SIN REALIZAR" : current);

            td.innerHTML = `
              <select class="jd-select" data-id="${row.id}" data-key="cumplido" aria-label="Cumplido">
                <option value="SIN REALIZAR" ${normalized === "SIN REALIZAR" ? "selected" : ""}>SIN REALIZAR</option>
                <option value="SI" ${normalized === "SI" ? "selected" : ""}>SI</option>
                <option value="NO" ${normalized === "NO" ? "selected" : ""}>NO</option>
              </select>
            `;
          } else {
            td.textContent = row[key] ?? "";
            td.contentEditable = "true";
          }

          tr.appendChild(td);
        }

        const tdA = document.createElement("td");
        tdA.className = "col-xs";
        tdA.innerHTML = `
          <div class="row-actions">
            <button class="icon-btn" title="Duplicar" data-action="dup" data-id="${row.id}">‚éò</button>
            <button class="icon-btn danger" title="Eliminar" data-action="del" data-id="${row.id}">‚úï</button>
          </div>
        `;
        tr.appendChild(tdA);

        tbody.appendChild(tr);
      }
    }

    /* =========================
       Firestore: realtime sync
    ========================== */
    const reservasRef = db.collection("reservas");

    // Escucha en tiempo real: si otro usuario edita/agrega, a vos te aparece
    reservasRef.orderBy("createdAt", "desc").onSnapshot((snap) => {
      const rows = [];
      snap.forEach(doc => {
        const d = doc.data() || {};
        const row = { id: doc.id };
        columns.forEach(c => row[c] = d[c] ?? "");
        rows.push(row);
      });
      data = rows;
      render();
    }, (err) => {
      console.error("Firestore onSnapshot error:", err);
      alert("Error conectando con Firebase (ver consola).");
    });

    async function updateCell(docId, key, value){
      // Normalizaci√≥n m√≠nima
      const payload = { [key]: value ?? "" , updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
      await reservasRef.doc(docId).set(payload, { merge: true });
    }

    async function deleteRow(docId){
      await reservasRef.doc(docId).delete();
    }

    async function addRow(){
      const empty = Object.fromEntries(columns.map(c => [c, ""]));
      empty.cumplido = "SIN REALIZAR";
      empty.fecha = nowDateStr();
      empty.horaCarga = nowTimeStr();
      empty.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      empty.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
      await reservasRef.add(empty);
    }

    async function duplicateRow(docId){
      const original = data.find(r => r.id === docId);
      if(!original) return;

      const copy = Object.fromEntries(columns.map(c => [c, original[c] ?? ""]));
      // Si quer√©s que al duplicar cambie fecha/hora, descoment√°:
      // copy.fecha = nowDateStr();
      // copy.horaCarga = nowTimeStr();

      copy.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      copy.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
      await reservasRef.add(copy);
    }

    /* =========================
       Events
    ========================== */

    // Enter: evitar saltos de l√≠nea
    tbody.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        e.target.blur();
      }
    });

    // Guardar cambios al salir de la celda
    tbody.addEventListener("focusout", async (e) => {
      const td = e.target.closest("td");
      if(!td || !td.dataset.key || !td.dataset.id) return;

      const key = td.dataset.key;
      const docId = td.dataset.id;

      // Cumplido se guarda por change del select
      if(key === "cumplido") return;

      const value = td.innerText.trim();
      try{
        await updateCell(docId, key, value);
      }catch(err){
        console.error(err);
        alert("No se pudo guardar el cambio en Firebase.");
      }
    });

    // Cumplido: guardar por cambio del select
    tbody.addEventListener("change", async (e) => {
      const sel = e.target.closest("select.jd-select");
      if(!sel) return;

      const docId = sel.dataset.id;
      const key = sel.dataset.key;
      const value = sel.value;

      try{
        await updateCell(docId, key, value);
      }catch(err){
        console.error(err);
        alert("No se pudo guardar Cumplido en Firebase.");
      }
    });

    // Acciones: duplicar / eliminar
    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;

      const action = btn.dataset.action;
      const docId = btn.dataset.id;

      try{
        if(action === "del"){
          if(!confirm("¬øEliminar esta fila?")) return;
          await deleteRow(docId);
        }
        if(action === "dup"){
          await duplicateRow(docId);
        }
      }catch(err){
        console.error(err);
        alert("Acci√≥n fall√≥ en Firebase.");
      }
    });

    // Toolbar
    document.getElementById("addRow").addEventListener("click", async () => {
      try{ await addRow(); }
      catch(err){ console.error(err); alert("No se pudo agregar fila."); }
    });

    document.getElementById("clearAll").addEventListener("click", async () => {
      if(!confirm("¬øSeguro que quer√©s vaciar TODA la tabla (Firebase)?")) return;

      try{
        const snap = await reservasRef.get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
      }catch(err){
        console.error(err);
        alert("No se pudo vaciar la tabla.");
      }
    });

    search.addEventListener("input", render);
    filterCumplido.addEventListener("change", render);

    /* =========================
       Exportar XLSX (extras)
       - ancho de columnas autom√°tico
       - fecha/hora como ‚Äúfecha‚Äù real de Excel
       - filtros en primera fila
       - freeze encabezado
    ========================== */

    function parseDateDMY(s){
      const str = (s ?? "").toString().trim();
      const m = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return null;
      const dd = Number(m[1]), mm = Number(m[2]), yyyy = Number(m[3]);
      const d = new Date(yyyy, mm-1, dd);
      return Number.isFinite(d.getTime()) ? d : null;
    }

    function parseTimeHMToExcel(s){
      const str = (s ?? "").toString().trim();
      const m = str.match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return null;
      const hh = Number(m[1]), mi = Number(m[2]);
      if(hh < 0 || hh > 23 || mi < 0 || mi > 59) return null;
      return (hh * 3600 + mi * 60) / 86400;
    }

    function autoColsFromAOA(aoa){
      const colCount = Math.max(...aoa.map(r => r.length));
      const maxLen = new Array(colCount).fill(0);

      for(const row of aoa){
        for(let c=0; c<colCount; c++){
          const v = row[c];
          let len = 0;
          if(v == null) len = 0;
          else if(v instanceof Date) len = 10;
          else if(typeof v === "number") len = 5;
          else len = String(v).length;
          if(len > maxLen[c]) maxLen[c] = len;
        }
      }
      return maxLen.map(n => ({ wch: Math.min(40, Math.max(10, n + 2)) }));
    }

    document.getElementById("exportXlsx").addEventListener("click", () => {
      const rows = data.filter(matchesFilters);

      const header = [
        "Caja","Material","Cantidad pack","Cantid","Descripci√≥n","Comentario",
        "O/C","Carpeta","Pedido Trasla","Sucurs","Fecha","Hora de carga","Cumplido"
      ];

      const aoa = [
        header,
        ...rows.map(r => ([
          r.caja ?? "",
          r.material ?? "",
          r.cantidadPack ?? "",
          r.cantid ?? "",
          r.descripcion ?? "",
          r.comentario ?? "",
          r.oc ?? "",
          r.carpeta ?? "",
          r.pedidoTrasla ?? "",
          r.sucurs ?? "",
          parseDateDMY(r.fecha) ?? "",
          parseTimeHMToExcel(r.horaCarga) ?? "",
          r.cumplido ?? ""
        ]))
      ];

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(aoa, { cellDates: true });

      const range = XLSX.utils.decode_range(ws["!ref"]);
      for(let R = range.s.r + 1; R <= range.e.r; R++){
        const dateCellAddr = XLSX.utils.encode_cell({ r:R, c:10 });
        const timeCellAddr = XLSX.utils.encode_cell({ r:R, c:11 });

        const dc = ws[dateCellAddr];
        if(dc && dc.v instanceof Date){
          dc.t = "d";
          dc.z = "dd/mm/yyyy";
        }

        const tc = ws[timeCellAddr];
        if(tc && typeof tc.v === "number"){
          tc.t = "n";
          tc.z = "hh:mm";
        }
      }

      ws["!freeze"] = { xSplit: 0, ySplit: 1 };
      ws["!autofilter"] = { ref: ws["!ref"] };
      ws["!cols"] = autoColsFromAOA(aoa);

      XLSX.utils.book_append_sheet(wb, ws, "Reservas");

      const d = new Date();
      const fileName = `reservas_importaciones_${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}.xlsx`;
      XLSX.writeFile(wb, fileName);
    });
  </script>
</body>
</html>
